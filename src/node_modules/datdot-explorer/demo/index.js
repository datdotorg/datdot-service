const datdot_explorer = require('..')

const port = 54321
console.error('@TODO: port 54321 is not the correct port of registry')
start(`http://localhost:${port}/peers.json`)

function reset () { location = location }

async function start (registry_url) {
  try {
    const addresses = await (await fetch(registry_url)).json()
    const el = datdot_explorer({ addresses })
    document.body.append(el)

    const base64icon = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQBAMAAADt3eJSAAAAMFBMVEU0OkArMjhobHEoPUPFEBIuO0L+AAC2FBZ2JyuNICOfGx7xAwTjCAlCNTvVDA1aLzQ3COjMAAAAVUlEQVQI12NgwAaCDSA0888GCItjn0szWGBJTVoGSCjWs8TleQCQYV95evdxkFT8Kpe0PLDi5WfKd4LUsN5zS1sKFolt8bwAZrCaGqNYJAgFDEpQAAAzmxafI4vZWwAAAABJRU5ErkJggg=="
    const link = document.createElement('link')
    link.setAttribute('rel', 'icon')
    link.setAttribute('type', 'image/png')
    link.setAttribute('sizes', '16x16')
    link.setAttribute('href', base64icon)
    document.head.append(link)

  } catch (error) {
    console.log(`What's error?`, error)
    document.body.innerHTML = `
      <strong> error
      (next auto-retry in 1 second)</strong>
      <pre>${error}</pre>
      <button> try again </button>
      <style>
        body {
          display: grid;
          place-content: center;
          width: 100vw;
          height: 100vh;
          font-family: mono;
        }
        button {
          padding: 20px;
          font-size: 50px;
        }
      </style>
    `
  const [button] = document.body.children
  button.onclick = reset
  setTimeout(reset, 1000)
  }
}
