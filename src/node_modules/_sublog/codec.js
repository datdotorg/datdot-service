const { performance } = require('perf_hooks')

module.exports = { encode, decode }

function decode (json) {
  const message = JSON.parse(json)
  verify(message)
  return message
}

function encode (message) {
  verify(message)
  return JSON.stringify(message)
}

function verify (message) {
  try {
    const { head: [from, to, id], refs: [...quotes], type, data } = message
    if (!type) throw new Error('missing message type')
    if (!Number.isInteger(id)) throw new Error('invalid message id')
    if (!to) throw new Error('missing message reciepient')
    if (!from) throw new Error('missing message sender')
    if (!data) throw new Error('missing message data')
    const len = quotes.length
    for (var i = 0; i < len; i++) {
      const [from, to, id] = quotes[i]
      if (!from) throw new Error('missing message sender')
      if (!to) throw new Error('missing message reciepient')
      if (!Number.isInteger(id)) throw new Error('invalid message id')
    }
  } catch (error) {
    throw [error, message]
  }
}
