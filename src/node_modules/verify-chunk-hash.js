const crypto = require('hypercore-crypto')
const brotli = require('brotli')
const parse_decompressed = require('parse-decompressed')

module.exports = verify_chunk_hash

async function verify_chunk_hash (index, encoded, encoder_id, nodes) {
  return new Promise(async (resolve, reject) => {
    const decompressed = await brotli.decompress(encoded)
    const decoded = parse_decompressed(decompressed, encoder_id)
    const node = nodes.find(node => node.index === index * 2)
    const hash = crypto.data(decoded)
    if (Buffer.compare(node.hash, hash)) reject()
    // console.log('Data hash verified')
    resolve()
  })
}