var init
module.exports = blockgenerator

function blockgenerator ({ actions, getLogger }, log, emit) {
  if (init) throw Error('block generator already initialized')
  var currentBlock = 0
  var executeBlock
  var unsubscribe
  var scheduled = []
  var total = 0 // TODO: make this BigInt

  init = setInterval(() => {
    // if (currentBlock === 0) {
    //   for (var i = 0; i < scheduled.length; i++) {
    //     const action = scheduled[i]
    //     action.executeBlock += currentBlock
    //   }
    // }
    currentBlock++
    scheduled = scheduled.filter(function keep ({ id, from, type, data, executeBlock }) {
      const logger = getLogger(from)
      if (!id) return
      if (executeBlock < currentBlock) setTimeout(() => {
        const action = actions[type]
        action(logger, data)
      }, 0)
      else if (executeBlock === currentBlock) {
        log({ type: 'block', data: [`Executing scheduled action: ${type}`] })
        setTimeout(() => {
          const action = actions[type]
          action(logger, data)
        }, 0)
      }
      else return true
    })
    emit({ type: 'block', data: { number: currentBlock } })
    log({ type: 'block', data: [`Current block: ${JSON.stringify(currentBlock)}`] })
  }, 2000)

  function scheduleAction ({ from, data, delay, type }) {
    if (delay <= 0) return void setTimeout(() => {
      const action = actions[type]
      action(getLogger(from), data)
    }, 0)
    const item = { from, type, data, executeBlock: currentBlock + delay/*currentBlock? currentBlock + delay : delay*/ }
    const id = item.id = total = total + 1
    scheduled.push(item)
    log({ type: 'schedule', data: [`Pushing new action: ${type}`] })
    return id
  }
  function cancelAction (id) {
    for (var i = 0, len = scheduled.length; i < len; i++) {
      if (scheduled[i].id === id) scheduled[i].id = undefined
    }
  }
  return { scheduleAction, cancelAction }
}
