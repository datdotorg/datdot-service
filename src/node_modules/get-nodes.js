const tree = require('flat-tree')

module.exports = get_nodes

async function get_nodes (feed, index, version) {
  return new Promise(async (resolve, reject) => {
    const all = []
    const v = version * 2

    all.push(index*2)
    const roots = tree.fullRoots(v)
    all.push(...roots)
        
    const nodes = await Promise.all(all.map(index => get_node(feed, index)))
    nodes.push(...await get_proof_nodes(feed, index))
    
    resolve(nodes)
  
  })
}

function get_proof_nodes (feed, index) {
  return new Promise((resolve, reject) => {
    feed.proof(index, (err, res) => {
      if (err) reject(err)
      resolve(res.nodes)
    })
  })
}

function get_node (feed, index) {
  return new Promise((resolve, reject) => {
    feed._storage.getNode(index, (err, node) => {
      if (err) reject(err)
      resolve(node)
    })
  })
}