module.exports = get_nodes

async function get_nodes (feed, index, version) {
  return new Promise((resolve, reject) => {
    const all = []
    var pending = 4
    feed._storage.getNode(index * 2, (err, node) => {
      if (err) reject(err)
      all.push(node)
      // console.log('got index node', {node})
      if (!--pending) done()
    })
    feed._storage.getNode(version * 2, (err, node) => {
      if (err) reject(err)
      all.push(node)
      // console.log('got version node', {node})
      if (!--pending) done()
    })
    feed.proof(index, {}, (err, res) => {
      if (err) reject(err)
      all.push(...res.nodes)
      // console.log('got proof', res.nodes)
      if (!--pending) done()
    })
    feed.rootHashes(version, (err, nodes) => {
      if (err) reject(err)
      all.push(...nodes)
      // console.log('got root node', {nodes})
      if (!--pending) done()
    })
    function done () {
      const all_nodes = [...new Set(all)].sort((a, b) => a.index - b.index < 0 ? -1 : 1)
      const info = {index, version, all_nodes}
      // console.log('done', info)
      resolve([all_nodes, info])
    }
  })
}