const hypercore = require('hypercore')
const hyperswarm = require('hyperswarm')
const b4a = require('b4a')

/******************************************************************************
  ROLE: author

    1. make a feed
    2. append some data to it
    3. send the public feedkey to another peer using an online chat

******************************************************************************/

module.exports = author_hypercore

// MAKE FEED and SEED IT

async function author_hypercore (vaultAPI, APIS) {
  const { log, config, store } = vaultAPI
  const { chainAPI } = APIS
  const account = await vaultAPI
  const getChatAPI = require('_chat/client')
  const chatAPI = await getChatAPI(vaultAPI)
  const datdot_crypto = require('../../datdot-crypto')

  log({ type: 'author', data: { text: `Make a feed and share it` } })
  
  const { feed } = await store.load_feed({ log })
  console.log({ author_feed: feed})

  await store.connect({
    feed,
    swarm_opts: { topic: feed.discoveryKey, mode: { server: true, client:false } },
    log
  })
    
  await feed.append(b4a.from('Hello World!'))
  await feed.append(b4a.from('Pozdravljen svet!'))
  await feed.append(b4a.from('你好，世界!'))
  await feed.append(b4a.from('Hola Mundo!'))
  await feed.append(b4a.from('สวัสดีชาวโลก!'))
  await feed.append(b4a.from('Hallo Welt!'))
  await feed.append(b4a.from('Bonjour le monde!'))
  await feed.append(b4a.from('Здраво Свете!'))
  await feed.append(b4a.from('Hai dunia!'))
  await feed.append(b4a.from('Mhoro nyika!'))
  await feed.append(b4a.from('Salom Dunyo!'))
  await feed.append(b4a.from('Halo Dunia!'))
  await feed.append(b4a.from('Kumusta kalibutan!'))
  await feed.append(b4a.from('Hei Verden!'))
  await feed.append(b4a.from('Ahoj svet!'))
  await feed.append(b4a.from('Hej världen!'))
  await feed.append(b4a.from('Helló Világ!'))

  const feedkey = feed.key
  const topic = feed.discoveryKey
  // const mode = { server: true, client: false }
  
  var tid
  var counter = 10
  // const bootstrap_nodes = [
  //   { host:'0.0.0.0', port: 10001 },
  //   { host:'0.0.0.0', port: 10002 },
  // ]
  // const swarm = new hyperswarm()
  // // const swarm = new hyperswarm({ bootstrap: bootstrap_nodes })
  // const discovery = swarm.join(topic, mode)
  // // await swarm.flush()
  // log({ type: 'author', data: { text: `Swarm joined` } })
  // retry(discovery, mode, log)
  // swarm.on('connection', (socket, info) => {
  //   log({ type: 'author', data: { text: `onconnection!`, isInitiator: socket.isInitiator }})
  //   clearTimeout(tid)
  //   socket.pipe(feed.replicate(socket.isInitiator)).pipe(socket)
  // })

  const keys = { feedkey, topic }
  setTimeout(() => { // TODO: - figure out why we need to wait
    chatAPI.send(JSON.stringify(keys))
    log({ type: 'author', data: [`Send the keys ${JSON.stringify(keys)}`] })
  }, 3000)

  // async function retry (discovery, mode, log) {
  //   tid = setTimeout(() => {
  //       log({ type: 'feed', data: { text: 'retrying connection' }})
  //       if (counter--) retry(discovery, mode, log)
  //   }, 1000)
  //   await discovery.refresh(mode)
  // }

}


// TODO: when anyone tries to connect to download data from the author, 
//they have to expect that the author doesn't have a task id => see how to deal with this