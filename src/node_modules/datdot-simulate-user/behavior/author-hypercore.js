const hypercore = require('hypercore')
const hyperswarm = require('hyperswarm')
const RAM = require('random-access-memory')
const load_feed = require('_datdot-service-helpers/load-feed')
const append = require('hypercore-append')

/******************************************************************************
  ROLE: author

    1. make a feed
    2. append some data to it
    3. send the public feedkey to another peer using an online chat

******************************************************************************/

module.exports = author_hypercore

// MAKE FEED and SEED IT

async function author_hypercore (profile, APIS) {
  const { log, config } = profile
  const { chainAPI, vaultAPI } = APIS
  const account = await vaultAPI
  const getChatAPI = require('_chat/client')
  const chatAPI = await getChatAPI(profile)

  log({ type: 'author', data: { text: `Make a feed and share it` } })
  
  const feed = await load_feed ({ role: 'author', account, log })
  
  await append(feed, 'Hello World!')
  await append(feed, 'Pozdravljen svet!')
  await append(feed, '你好，世界!')
  await append(feed, 'Hola Mundo!')
  await append(feed, 'สวัสดีชาวโลก!')
  await append(feed, 'Hallo Welt!')
  await append(feed, 'Bonjour le monde!')
  await append(feed, 'Здраво Свете!')
  await append(feed, 'Hai dunia!')
  await append(feed, 'Mhoro nyika!')
  await append(feed, 'Salom Dunyo!')
  await append(feed, 'Halo Dunia!')
  await append(feed, 'Kumusta kalibutan!')
  await append(feed, 'Hei Verden!')
  await append(feed, 'Ahoj svet!')
  await append(feed, 'Hej världen!')
  await append(feed, 'Helló Világ!')

  const feedkey = feed.key
  const topic = feed.discoveryKey
  // const mode = { server: true, client: false }
  
  var tid
  var counter = 10
  // const bootstrap_nodes = [
  //   { host:'0.0.0.0', port: 10001 },
  //   { host:'0.0.0.0', port: 10002 },
  // ]
  // const swarm = new hyperswarm()
  // // const swarm = new hyperswarm({ bootstrap: bootstrap_nodes })
  // const discovery = swarm.join(topic, mode)
  // // await swarm.flush()
  // log({ type: 'author', data: { text: `Swarm joined` } })
  // retry(discovery, mode, log)
  // swarm.on('connection', (socket, info) => {
  //   log({ type: 'author', data: { text: `onconnection!`, isInitiator: socket.isInitiator }})
  //   clearTimeout(tid)
  //   socket.pipe(feed.replicate(socket.isInitiator)).pipe(socket)
  // })

  const keys = { feedkey, topic }
  setTimeout(() => { // TODO - figure out why we need to wait
    chatAPI.send(JSON.stringify(keys))
    log({ type: 'author', data: [`Send the keys ${JSON.stringify(keys)}`] })
  }, 3000)

  // async function retry (discovery, mode, log) {
  //   tid = setTimeout(() => {
  //       log({ type: 'feed', data: { text: 'retrying connection' }})
  //       if (counter--) retry(discovery, mode, log)
  //   }, 1000)
  //   await discovery.refresh(mode)
  // }

}


// TODO: when anyone tries to connect to download data from the author, 
//they have to expect that the author doesn't have a task id => see how to deal with this