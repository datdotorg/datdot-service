const providerForm = require('_provider-form')
const dateToBlockNumber = require('_date-to-blocknumber')
/******************************************************************************
  ROLE: worker

    1. register for work (= publish offered services to chain)
    2. listen to task notifications
    3. execute tasks
    4. report task results to chain if required

******************************************************************************/

module.exports = offer_hosting

async function offer_hosting (profile, APIS) {
  const { name, log } = profile
  const { chainAPI, vaultAPI, serviceAPI } = APIS
  
  const myAddress = await vaultAPI.chainKeypair.address
  const nonce = await vaultAPI.getNonce()
  const signer = await vaultAPI.chainKeypair
  const noiseKey = await vaultAPI.noisePublicKey
  const identity = { myAddress, signer, noiseKey }
  
  const blockNow = await chainAPI.getBlockNumber()
  const duration = await get_duration(blockNow)
  const form = providerForm(duration)

  // @TODO: do not pass APIS but instead forward calls between APIS
  log({ type: '@todo', data: 'do not pass APIS but instead forward calls between APIS' })

  serviceAPI.encode(identity, log, APIS)
  serviceAPI.host(identity, log, APIS)
  serviceAPI.attest(identity, log, APIS)

  await chainAPI.registerForWork({ signer, nonce, form })
}

async function get_duration (blockNow) {
  const until = new Date('Dec 26, 2021 23:55:00')
  const untilBlock = dateToBlockNumber ({ dateNow: new Date(), blockNow, date: until })
  return { from: blockNow, until: untilBlock }
}