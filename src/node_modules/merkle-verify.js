const hypercore = require('hypercore')
const ready = require('hypercore-ready')
const RAM = require('random-access-memory')

module.exports = verify_chunk

async function verify_chunk (feedKey, data, index, nodes, signature) {
  data =  Buffer.from(data, 'binary')
  signature = Buffer.from(signature)
  feedKey = Buffer.from(feedKey, 'hex')

  const feed = new hypercore(RAM, feedKey, { valueEncoding: 'binary', sparse: true })
  
  feed._open(async () => {
    const packet = {
      index,
      value: data,
      nodes,
      signature
    }
    
    // This should throw if the data is invalid
    await new Promise((resolve, reject) => {
      feed._putBuffer(index, data, packet, {}, (err) => {
        if (err) { reject(err)}
        else { resolve() }
      })
    })
  })

}