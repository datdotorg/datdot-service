const c = require('compact-encoding')

module.exports = {
  make_protocol,
  create_and_open_channel,
  // add_string_msg
}

async function make_protocol ({ mux, opts, cb, log }) {
  log({ type: 'mux-proto', data: { text: 'make protocol' } })
  // mux.pair(opts, cb) only saves that "cb" function in a Map just to be called when there is a pair incoming, like a notification
  // so if channel is closed but stream is still connected, then it can re-open the protocol due to mux.pair still triggering the callback
  mux.pair(opts, cb) 
  // mux.unpair when you want to close the channel
  const opened = await mux.stream.opened
  if (opened) cb()
}

function create_and_open_channel ({ mux, opts, log }) {
  const channel = mux.createChannel(opts)
  log({ type: 'mux-proto', data: { text: 'channel created' } })
  if (!channel) {
    log({ type: 'mux-proto', data: { text: 'Error: no channel' } })
    return
  }
  channel.open()
  log({ type: 'mux-proto', data: { text: 'channel opened' } })
  return channel
}