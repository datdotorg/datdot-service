const c = require('compact-encoding')

module.exports = {
  make_protocol,
  create_and_open_channel,
  // add_string_msg
}

async function make_protocol (mux, opts, cb, log) {
  mux.pair(opts, callback)
  // mux.unpair when you want to close the channel
  log({ type: 'mux-proto', data: { text: 'make protocol' } })
  const opened = await mux.stream.opened
  if (opened) callback()

  function callback () {
    if (mux.opened(opts)) return
    cb()
  }
}

function create_and_open_channel (mux, opts, log) {
  const channel = mux.createChannel(opts)
  log({ type: 'mux-proto', data: { text: 'channel created', is_channel: channel ? 'yes':'no' } })
  if (!channel) return
  channel.open()
  log({ type: 'mux-proto', data: { text: 'channel opened' } })
  return channel

}