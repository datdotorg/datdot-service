const c = require('compact-encoding')

module.exports = {
  make_protocol,
  create_and_open_channel,
  add_string_msg
}

async function make_protocol (mux, opts, cb) {
  mux.pair(opts, callback)
  const opened = await mux.stream.opened
  console.log({ text: 'mux proto', mux_stream_opened: opened, mux_opened: mux.opened(opts) })
  if (opened) callback()
  function callback () {
    cb(mux.opened(opts))
  }
}

function create_and_open_channel (mux, opts) {
  const channel = mux.createChannel(opts)
  console.log({ text: 'mux proto - channel created' })
  if (!channel) return
  channel.open()
  console.log({ text: 'mux proto - channel opened' })
  return channel
}

function add_string_msg (channel, onmessage) {
  const msg = channel.addMessage({
    encoding: c.string,
    onmessage
  })
  console.log({ text: 'mux proto - string message type added' })
  return msg
}